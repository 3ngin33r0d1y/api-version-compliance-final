import{r as d,j as e,g as C}from"./index-IGC9mBRL.js";const S=["DEV","UAT","OAT","PROD"];function M(n){if(!n)return null;const t=n.trim().toUpperCase();return t==="DEVELOP"||t==="DEVELOPMENT"?"DEV":t==="TEST"||t==="QA"?"UAT":t==="PREPROD"||t==="PRE-PROD"?"OAT":t==="PRODUCTION"?"PROD":S.includes(t)?t:null}function D(n){if(!n)return null;const i=String(n).trim().split(/[+-]/)[0].split(".");if(i.length===0)return null;const l=i.slice(0,3).map(a=>{const p=parseInt(a.replace(/[^0-9]/g,""),10);return Number.isFinite(p)?p:0});for(;l.length<3;)l.push(0);return l.every(a=>Number.isFinite(a))?[l[0],l[1],l[2]]:null}function R(n,t){const i=D(n),l=D(t);if(!i||!l)return null;for(let a=0;a<3;a++){if(i[a]>l[a])return 1;if(i[a]<l[a])return-1}return 0}function k(){const[n,t]=d.useState([]),[i,l]=d.useState(!1),[a,p]=d.useState(null),[E,U]=d.useState(null);async function N(){l(!0),p(null);try{const{data:s}=await C("/data/projects");t(s||[]),U(new Date)}catch(s){p((s==null?void 0:s.message)||"Failed to load projects")}finally{l(!1)}}d.useEffect(()=>{N();const s=setInterval(N,3e4);return()=>clearInterval(s)},[]);const O=d.useMemo(()=>(n??[]).flatMap(s=>(s.apis||[]).map(c=>({...c,projectId:s.id}))),[n]),T=d.useMemo(()=>{var c,m,j,A,w;const s={};for(const r of O){const v=M(r.environment);if(!v)continue;const o=(((c=r.serviceName)==null?void 0:c.trim())||P(r.url)).toLowerCase(),b=((m=r.serviceName)==null?void 0:m.trim())||P(r.url);s[o]||(s[o]={serviceKey:o,displayName:b,byEnv:{},violations:[],compliant:!0}),s[o].byEnv[v]=r}for(const r of Object.values(s)){const v=((j=r.byEnv.PROD)==null?void 0:j.version)??null,o=((A=r.byEnv.OAT)==null?void 0:A.version)??null,b=((w=r.byEnv.UAT)==null?void 0:w.version)??null;r.byEnv.PROD&&r.byEnv.OAT?R(v,o)===1&&r.violations.push(`Version drift: PROD (${v||"?"}) > OAT (${o||"?"})`):r.byEnv.PROD&&!r.byEnv.OAT&&r.violations.push("Missing OAT deployment while PROD exists"),r.byEnv.OAT&&r.byEnv.UAT?R(o,b)===1&&r.violations.push(`Version drift: OAT (${o||"?"}) > UAT (${b||"?"})`):r.byEnv.OAT&&!r.byEnv.UAT&&r.violations.push("Missing UAT deployment while OAT exists"),r.compliant=r.violations.length===0}return s},[O]),h=d.useMemo(()=>Object.values(T).sort((s,c)=>s.displayName.localeCompare(c.displayName)),[T]),f=d.useMemo(()=>{const s=h.length,c=h.filter(j=>j.compliant).length,m=s>0?Math.round(c/s*100):100;return{total:s,compliant:c,nonCompliant:s-c,score:m}},[h]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Compliance"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Version-drift checks across environments (rules: PROD > OAT is a violation, OAT > UAT is a violation)."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:N,disabled:i,className:"rounded border px-3 py-2 text-sm hover:bg-gray-50 disabled:opacity-60",children:i?"Refreshing…":"Refresh"}),E&&e.jsxs("span",{className:"text-xs text-gray-500",children:["Last updated: ",E.toLocaleTimeString()]})]})]}),e.jsxs("section",{className:"grid grid-cols-1 gap-4 md:grid-cols-4",children:[e.jsxs(g,{title:"Compliance Score",children:[e.jsxs("div",{className:"text-3xl font-bold",children:[f.score,"%"]}),e.jsx(L,{value:f.score})]}),e.jsx(g,{title:"Total Services",children:e.jsx("div",{className:"text-3xl font-bold",children:f.total})}),e.jsx(g,{title:"Compliant",children:e.jsx("div",{className:"text-3xl font-bold text-emerald-600",children:f.compliant})}),e.jsx(g,{title:"Violations",children:e.jsx("div",{className:"text-3xl font-bold text-red-600",children:f.nonCompliant})})]}),e.jsx("section",{className:"rounded-lg border bg-white",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-left",children:e.jsxs("tr",{children:[e.jsx(x,{children:"Service"}),e.jsx(x,{className:"w-[13%]",children:"DEV"}),e.jsx(x,{className:"w-[13%]",children:"UAT"}),e.jsx(x,{className:"w-[13%]",children:"OAT"}),e.jsx(x,{className:"w-[13%]",children:"PROD"}),e.jsx(x,{children:"Violations"}),e.jsx(x,{className:"w-[10%]",children:"Status"})]})}),e.jsxs("tbody",{children:[h.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx(u,{className:"font-medium",children:s.displayName}),e.jsx(y,{item:s.byEnv.DEV,env:"DEV"}),e.jsx(y,{item:s.byEnv.UAT,env:"UAT"}),e.jsx(y,{item:s.byEnv.OAT,env:"OAT"}),e.jsx(y,{item:s.byEnv.PROD,env:"PROD"}),e.jsx(u,{children:s.violations.length===0?e.jsx("span",{className:"text-emerald-600",children:"—"}):e.jsx("ul",{className:"list-disc pl-5 space-y-1",children:s.violations.map((c,m)=>e.jsx("li",{className:"text-red-700",children:c},m))})}),e.jsx(u,{children:s.compliant?e.jsx("span",{className:"inline-flex items-center rounded bg-emerald-50 px-2 py-1 text-xs font-medium text-emerald-700",children:"Compliant"}):e.jsx("span",{className:"inline-flex items-center rounded bg-red-50 px-2 py-1 text-xs font-medium text-red-700",children:"Violation"})})]},s.serviceKey)),h.length===0&&e.jsx("tr",{children:e.jsx(u,{colSpan:7,className:"text-center text-gray-500 py-8",children:"No services found."})})]})]})})}),a&&e.jsx("div",{className:"rounded border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:a})]})}function P(n){try{const t=new URL(n);return t.pathname.split("/").filter(Boolean)[0]||t.hostname}catch{return n}}function x({children:n,className:t=""}){return e.jsx("th",{className:`px-3 py-2 text-xs font-semibold uppercase tracking-wide text-gray-600 ${t}`,children:n})}function u({children:n,className:t="",colSpan:i}){return e.jsx("td",{className:`px-3 py-2 align-top ${t}`,colSpan:i,children:n})}function g({title:n,children:t}){return e.jsxs("div",{className:"rounded-lg border bg-white p-4",children:[e.jsx("div",{className:"text-xs font-semibold uppercase text-gray-500",children:n}),e.jsx("div",{className:"mt-2",children:t})]})}function L({value:n}){return e.jsx("div",{className:"mt-2 h-2 w-full rounded bg-gray-200",children:e.jsx("div",{className:"h-2 rounded bg-black transition-all duration-500",style:{width:`${Math.max(0,Math.min(100,n))}%`}})})}function y({item:n,env:t}){if(!n)return e.jsx(u,{children:e.jsx("span",{className:"rounded bg-gray-100 px-2 py-0.5 text-xs text-gray-500",children:"—"})});const i=n.version||"?",l=t==="PROD"?"bg-purple-50 text-purple-700":t==="OAT"?"bg-blue-50 text-blue-700":t==="UAT"?"bg-amber-50 text-amber-700":"bg-gray-100 text-gray-700";return e.jsx(u,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:`inline-flex w-fit items-center rounded px-2 py-0.5 text-xs ${l}`,children:[t," — v",i]}),e.jsx("div",{className:"text-[11px] text-gray-500 max-w-[220px] truncate",title:n.url,children:n.url})]})})}export{k as default};
