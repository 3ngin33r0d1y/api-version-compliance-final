import{r as c,j as e,R as F,a as w,b as L}from"./index-DiAMUAL0.js";const g=["DEV","UAT","OAT","PROD"],T=t=>{const n=(t||"").toUpperCase();return g.includes(n)?n:n.startsWith("PRD")||n.startsWith("PROD")?"PROD":n.includes("UAT")?"UAT":n.includes("OAT")?"OAT":"DEV"},M=({status:t})=>{const n=(t||"unknown").toLowerCase();let d="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium border";return n==="online"?d+=" bg-green-100 text-green-800 border-green-300":n==="offline"?d+=" bg-red-100 text-red-800 border-red-300":d+=" bg-gray-100 text-gray-800 border-gray-300",e.jsx("span",{className:d,children:n})},z=({open:t,onClose:n,title:d,children:h,footer:p})=>t?e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:n}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"w-full max-w-lg rounded-xl bg-white shadow-xl",children:[e.jsx("div",{className:"border-b px-5 py-4",children:e.jsx("h2",{className:"text-lg font-semibold",children:d})}),e.jsx("div",{className:"px-5 py-4",children:h}),e.jsx("div",{className:"flex items-center justify-end gap-2 border-t px-5 py-3",children:p})]})})]}):null;function $(){const[t,n]=c.useState(null),[d,h]=c.useState(!1),[p,f]=c.useState(null),[O,v]=c.useState(!1),[x,A]=c.useState(null),[m,S]=c.useState(""),[k,U]=c.useState("DEV"),[E,D]=c.useState("north"),[j,b]=c.useState(!1),y=async()=>{var s,l,i;h(!0),f(null);try{const a=await w.get("/data/projects");n(a.data),x==null&&((s=a.data.projects)!=null&&s.length)&&A(a.data.projects[0].id)}catch(a){const r=a;((l=r.response)==null?void 0:l.status)===401||((i=r.response)==null?void 0:i.status)===403?f("Forbidden (403) — you are not authorized. Please log in again."):f("Failed to load projects. Check server logs.")}finally{h(!1)}};c.useEffect(()=>{y();const s=window.setInterval(y,3e4);return()=>window.clearInterval(s)},[]);const R=c.useMemo(()=>{var a;if(!t)return[];const s=t.apisMeta||{},l=new Map,i=((a=t.allApis)!=null&&a.length?t.allApis:t.apis)||[];for(const r of i){const o=s[String(r.id)]||{};let u=o.service;if(!u)try{u=new URL(r.url).hostname}catch{u="unknown-service"}const C=T(r.environment),N=l.get(u)||{service:u,byEnv:{}},P=N.byEnv[C]||{};P[r.region]={version:o.version,url:r.url,status:r.status||"unknown"},N.byEnv[C]=P,l.set(u,N)}return Array.from(l.values()).sort((r,o)=>r.service.localeCompare(o.service))},[t]),I=async()=>{var s,l;if(!(!x||!m)){b(!0);try{const i=await L.get(m,{timeout:8e3}),{version:a,service:r}=i.data||{};if(!a||!r){alert('The endpoint must return JSON like: {"version":"1.0.0","service":"api-name"}'),b(!1);return}await w.post(`/data/projects/${x}/apis`,{url:m.trim(),environment:k,region:E,version:a,service:r});try{await w.post("/proxy/check",{url:m.trim()})}catch{}v(!1),S(""),y()}catch(i){const a=i;((s=a.response)==null?void 0:s.status)===401||((l=a.response)==null?void 0:l.status)===403?alert("Unauthorized. Please log in again."):alert("URL check or save failed. Ensure the URL is reachable and returns the required JSON."),console.error(i)}finally{b(!1)}}};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"All APIs"}),e.jsx("button",{className:"inline-flex items-center rounded-md bg-black px-4 py-2 text-sm font-medium text-white hover:bg-black/90 disabled:opacity-50",onClick:()=>v(!0),disabled:!!p,children:"Add API"})]}),p&&e.jsxs("div",{className:"rounded-lg border border-red-300 bg-red-50 px-4 py-3 text-sm text-red-800",children:[p," — Make sure your login saves a JWT into ",e.jsx("code",{children:'localStorage["token"]'}),"."]}),e.jsxs("div",{className:"rounded-xl border",children:[e.jsx("div",{className:"border-b px-5 py-4",children:e.jsx("div",{className:"flex items-baseline justify-between",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-semibold",children:"Services"}),e.jsx("div",{className:"text-sm text-gray-500",children:d?"Refreshing…":`Last updated ${t!=null&&t.fetchedAt?new Date(t.fetchedAt).toLocaleString():""}`})]})})}),e.jsx("div",{className:"px-5 py-4",children:e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsxs("div",{className:"min-w-[900px] grid grid-cols-[1.2fr,1fr,1fr,1fr,1fr]",children:[e.jsx("div",{className:"px-3 py-2 font-medium bg-gray-50 border",children:"Service"}),g.map(s=>e.jsx("div",{className:"px-3 py-2 font-medium bg-gray-50 border text-center",children:s},s)),R.map(s=>e.jsxs(F.Fragment,{children:[e.jsx("div",{className:"px-3 py-2 border flex items-center",children:e.jsx("span",{className:"font-medium",children:s.service})}),g.map(l=>{const i=s.byEnv[l]||{},a=Object.keys(i);return e.jsx("div",{className:"px-3 py-2 border align-top",children:a.length>0?e.jsx("div",{className:"flex flex-col gap-2",children:a.map(r=>{const o=i[r];return e.jsxs("div",{className:"text-xs",children:[e.jsx("div",{className:"font-medium",children:r.toUpperCase()}),e.jsxs("div",{children:["v",o.version||"?"]}),e.jsx("div",{className:"truncate max-w-[220px]",children:o.url}),e.jsx(M,{status:o.status})]},r)})}):e.jsx("div",{className:"text-sm text-gray-400 italic",children:"—"})},`${s.service}-${l}`)})]},s.service)),!d&&R.length===0&&e.jsxs("div",{className:"col-span-5 px-3 py-6 text-center text-sm text-gray-500",children:["No APIs yet. Click ",e.jsx("strong",{children:"Add API"})," to get started."]})]})})})]}),e.jsx(z,{open:O,onClose:()=>v(!1),title:"Add an API",footer:e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"rounded-md border px-4 py-2 text-sm hover:bg-gray-50",onClick:()=>v(!1),disabled:j,children:"Cancel"}),e.jsx("button",{className:"rounded-md bg-black px-4 py-2 text-sm font-medium text-white hover:bg-black/90 disabled:opacity-50",disabled:!x||!m||j,onClick:I,children:j?"Saving…":"Save"})]}),children:e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx("label",{className:"text-sm font-medium",children:"Project"}),e.jsxs("select",{className:"w-full rounded-md border px-3 py-2 text-sm",value:(x==null?void 0:x.toString())||"",onChange:s=>A(parseInt(s.target.value,10)),children:[e.jsx("option",{value:"",disabled:!0,children:"Select project"}),((t==null?void 0:t.projects)||[]).map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx("label",{className:"text-sm font-medium",children:"API URL"}),e.jsx("input",{className:"w-full rounded-md border px-3 py-2 text-sm",placeholder:"https://api.example.com/health",value:m,onChange:s=>S(s.target.value)}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Endpoint must return ",e.jsx("code",{children:'{ "version": "x.y.z", "service": "name" }'})]})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx("label",{className:"text-sm font-medium",children:"Region"}),e.jsxs("select",{className:"w-full rounded-md border px-3 py-2 text-sm",value:E,onChange:s=>D(s.target.value),children:[e.jsx("option",{value:"north",children:"north"}),e.jsx("option",{value:"paris",children:"paris"})]})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx("label",{className:"text-sm font-medium",children:"Environment"}),e.jsx("select",{className:"w-full rounded-md border px-3 py-2 text-sm",value:k,onChange:s=>U(s.target.value),children:g.map(s=>e.jsx("option",{value:s,children:s},s))})]})]})})]})}export{$ as default};
